name: CI Workflow

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
      - develop
  workflow_dispatch:

env:
  COMPONENT: builder
  AWS_ACCCOUNT_ID: 243963068353
  AWS_ECR_REGION: us-west-2

jobs:
  lint-dockerfile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lint builder Dockerfile
        # # Only run on pull requests, disable on workflow development
        if: github.event_name == 'pull_request'
        uses: hadolint/hadolint-action@v2.1.0
        with:
          dockerfile: ./dockerfile/builder/Dockerfile

      - name: Lint api Dockerfile
        # # Only run on pull requests, disable on workflow development
        if: github.event_name == 'pull_request'
        uses: hadolint/hadolint-action@v2.1.0
        with:
          dockerfile: ./dockerfile/api/Dockerfile

  build-application:
    needs: [lint-dockerfile]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - uses: actions/setup-go@v3
        with:
          go-version: ">=1.19.0"
      - run: go version

      - name: build server
        run: |
          make buildserver

  build-scan-builder-images:
    needs: [build-application]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build builder image
        run: |
          docker build \
            -t ${{ env.AWS_ACCCOUNT_ID }}.dkr.ecr.${{ env.AWS_ECR_REGION }}.amazonaws.com/${{ env.COMPONENT }}:latest \
            -f ./dockerfile/builder/Dockerfile \
            .

      - name: Scan builder image using Trivy
        # # Only run on pull requests, disable on workflow development
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.AWS_ACCCOUNT_ID }}.dkr.ecr.${{ env.AWS_ECR_REGION }}.amazonaws.com/${{ env.COMPONENT }}:latest
          format: template
          template: "@/contrib/sarif.tpl"
          output: trivy-results.sarif
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

  build-scan-api-images:
    needs: [build-scan-builder-images]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build api image
        run: |
          docker build \
            -t ${{ env.AWS_ACCCOUNT_ID }}.dkr.ecr.${{ env.AWS_ECR_REGION }}.amazonaws.com/${{ env.COMPONENT }}:latest \
            -f ./dockerfile/api/Dockerfile \
            .

      - name: Scan api image using Trivy
        # # Only run on pull requests, disable on workflow development
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.AWS_ACCCOUNT_ID }}.dkr.ecr.${{ env.AWS_ECR_REGION }}.amazonaws.com/${{ env.COMPONENT }}:latest
          format: template
          template: "@/contrib/sarif.tpl"
          output: trivy-results.sarif
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

  # push-images-to-ecr:
